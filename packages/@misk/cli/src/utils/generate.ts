import * as fs from "fs-extra"
import {
  Files,
  IMiskTabJSON,
  JsonOptions,
  logDebug,
  path,
  parseArgs
} from "../utils"
import {
  createPackage,
  createTsconfig,
  generatedByCLI,
  gitignore,
  tslint,
  webpack
} from "./templates"
import { getVersion } from "./changelog"

const tag = "generate"

export const generateBuildFiles = async (...args: any) => {
  const { dir } = parseArgs(...args)
  logDebug(tag, "", dir)
  let pkg = {}
  if (fs.existsSync(path(dir, Files.package))) {
    pkg = fs.readJsonSync(path(dir, Files.package))
  }
  const miskTab: IMiskTabJSON = await fs.readJsonSync(path(dir, Files.miskTab))
  // Write out fresh files
  await [
    fs.writeJson(
      path(dir, Files.tsconfig),
      createTsconfig(miskTab),
      JsonOptions
    ),
    fs.writeJson(path(dir, Files.tslint), tslint, JsonOptions),
    fs.writeJson(
      path(dir, Files.package),
      createPackage(miskTab, pkg),
      JsonOptions
    ),
    fs.writeFile(path(dir, Files.gitignore), gitignore),
    fs.writeFile(path(dir, Files.webpack), webpack)
  ]

  // Append non-package JSON files with generated by comment
  fs.writeFile(path(dir, Files.tsconfig), generatedByCLI, { flag: "a" })
  fs.writeFile(path(dir, Files.tslint), generatedByCLI, { flag: "a" })
  logDebug(
    tag,
    `Up to date build files generated using Misk Web version ${getVersion(
      miskTab.version
    )}`,
    dir
  )
}
